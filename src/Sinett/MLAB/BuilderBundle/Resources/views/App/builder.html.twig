{% extends '::base.html.twig' %}

{% block body -%}

    <h1>{% trans %}app.builder.list.main.heading{% endtrans %}</h1>
	<p class="builder_welcome">{% trans %}app.builder.list.welcome.info{% endtrans %}</p>
	<p><a class="mlab_button_new_app" href="javascript: mlab_app_new();">{% trans %}app.builder.list.new.app.button{% endtrans %}</a></p>
    <table class="records_list app_list" id="table_app">
        <thead>
            <tr>
                <th>{% trans %}app.builder.list.heading.app{% endtrans %}</th>
                <th class="hidden"></th>
                <th>{% trans %}app.builder.list.heading.version{% endtrans %}</th>
                <th>{% trans %}app.builder.list.heading.last.updated{% endtrans %}</th>
                <th class="mlab_align_center">{% trans %}app.builder.list.heading.published{% endtrans %}</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
	        {% for app in apps %}
		        {{ include( 'SinettMLABBuilderBundle:App:list.html.twig', { 'app': app } ) }}
	        {% endfor %}
        </tbody>
    </table>
    <div id="builder_dialog_new_app"></div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script src="{{ asset('/js/jquery.ddslick-1.0.0.js') }}"></script>
	<script>
		var url_new = "{{ path('app_new') }}";
		var url_edit = "{{ path('app_edit', {id: 0} ) }}";
		
		$(document).ready(function() {

			$("#builder_dialog_new_app").dialog( {
					title: "{% trans %}App details{% endtrans %}",
					autoOpen: false,
				    show: { effect: "blind", duration: 500 },
				    hide: { effect: "blind", duration: 500 },
                    close: function(event, ui) { $("#builder_dialog_new_app").html("") },
				    width: 800,
				    height: 670,
				    modal: true,
				});
			
		});

		/**
		 * Opens up the properties dialog and displays a blank form
		*/
		function mlab_app_new () {
			$("#builder_dialog_new_app").load(url_new).dialog("open");
		};
		
		/**
		 * Opens up the properties dialog for a given app, uses the predefined URL and replaces the 0 placeholder
		*/
		function mlab_app_edit (id) {
            var url_temp = url_edit.replace(/0/ , id);
			$("#builder_dialog_new_app").load(url_temp).dialog("open");
		};
        
		/**
		 * submits data for new app from the dialog box where we collect details of the new app  
		 */
		function mlab_app_submit_properties(form) {
            formData = new FormData(document.getElementById('mlab_form_app'))
            
			$.ajax({
		        url: form.attr( "action" ),  //Server script to process data, should be createAction in app controller 
		        type: 'POST',
		        // Form data 
		        data: formData,
                cache: false,
                contentType: false,
                processData: false,
		        success: function( data ) {
			    	if (data.result == 'FAILURE') {
			    		alert(data.message);
                        $('#form_copyApp').ddslick({
                            width: 300,
                            imagePosition: "left",
                            selectText: "{% trans %}app.select.app.to.copy{% endtrans %}"
                        });

                        $('#form_template').ddslick({
                            width: 300,
                            height: 110,
                            imagePosition: "left",
                            selectText: "{% trans %}app.select.template{% endtrans %}"
                        });


			    	} else {
//here we update the list of apps with the new app details
                        $("#builder_dialog_new_app").dialog("close");
                        $(data.html).appendTo("#table_app");
			    	}
			  	},
		        error: function(e) {
                    alert('An error occurred, see console log for more information'); 
                    console.log(e);
                    $('#form_copyApp').ddslick({
                        width: 300,
                        imagePosition: "left",
                        selectText: "{% trans %}app.select.app.to.copy{% endtrans %}"
                    });

                    $('#form_template').ddslick({
                        width: 300,
                        height: 110,
                        imagePosition: "left",
                        selectText: "{% trans %}app.select.template{% endtrans %}"
                    });
                    
                }
		    });
		}
		
	</script>
{% endblock %}