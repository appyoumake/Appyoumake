function Mlab_dt_management(){this.parent=null}Mlab_dt_management.prototype={app_open:function(c,e){var a=e;var b=this.parent.urls.app_open.replace("_ID_",c);b=b.replace("_PAGE_NUM_","index");b=b.replace("_UID_",this.parent.uid);b=b.replace("_OPEN_MODE_","true");this.parent.utils.update_status("callback",_tr["mlab.dt.management.js.update_status.opening.app"],true);var f=this;var d=c;$.get(b,function(g){if(g.result=="success"){f.index_page_process(g.html,"index",(a=="0"||a=="index"||f.parent.app.page_names.length==1));mlab.dt.app.compiled_files=g.compiled_files;$.each(mlab.dt.config.compiler_service.supported_platforms,function(k,j){if(typeof mlab.dt.app.compiled_files[j]!="undefined"){var l=document.getElementsByTagName("base")[0].href.slice(0,-1)+"_compiled/"+mlab.dt.app.compiled_files[j];$("#mlab_download_qr_link_"+j).empty().qrcode({text:l,size:150,background:"#ffffff",foreground:"#000000",render:"table"});$("#mlab_download_link_"+j).html("<b>URL</b>:</br>"+l)}});$("#mlab_statusbar_permanent").html(mlab.dt.app.name);$("#mlab_features_list li").removeClass("mlab_item_applied");$(f.parent.app.curr_indexpage_html).find("#mlab_features_content [data-mlab-type]>").each(function(){$("#mlab_features_list [data-mlab-feature-type='"+$(this).parent().data("mlab-type")+"']").addClass("mlab_item_applied")});if(g.only_index&&$("#"+f.parent.config.app["content_id"]).children().length==0){var h=prompt(_tr["mlab.dt.management.js.prompt.title.front.page"],f.parent.app.curr_pagetitle);if(h!=null){f.parent.app.curr_pagetitle=h;$("#mlab_page_control_title").text(f.parent.app.curr_pagetitle);f.parent.flag_dirty=true}}if(a!="0"&&a!="index"&&!g.only_index){f.page_open_process(g.app_id,a)}else{if(g.lock_status=="locked"){f.parent.app.locked=true;$("#"+f.parent.config.app["content_id"]).fadeTo("slow",0.6);$("div.container").append('<div id="mlab_editor_disabled" style="background-color: gray; position: absolute;top:110px;left:0;width: 100%;height:100%;z-index:2;opacity:0.4;filter: alpha(opacity = 50); background-image: url(/img/page_locked.png); background-repeat: no-repeat; background-position: 95% 2%;"></div>')}else{f.parent.app.locked=false;$("#mlab_editor_disabled").remove();$("#"+f.parent.config.app["content_id"]).fadeTo("slow",1)}f.parent.utils.update_status("temporary",_tr["mlab.dt.management.js.update_status.ready"],false);$("#mlab_overlay").slideUp();f.parent.app.locked=(g.lock_status=="locked");f.parent.utils.timer_start()}}else{f.parent.utils.update_status("temporary",g.msg,false)}$("#"+mlab.dt.config.app["content_id"]).on("paste",function(j){j.preventDefault();var l=$(".mlab_current_component").data("mlab-type");if(typeof mlab.dt.components[l].conf.paste_allowed=="undefined"||mlab.dt.components[l].conf.paste_allowed===false){return}var k=j.originalEvent.clipboardData.getData("text/plain");document.execCommand("insertHTML",false,k);mlab.dt.flag_dirty=true})})},app_download:function(){that=this;this.page_save(function(){that.app_download_process()})},app_download_process:function(){this.parent.utils.update_status("callback",_tr["mlab.dt.management.js.update_status.retrieving.app"],true);var a=this.parent.urls.app_download.replace("_ID_",this.parent.app.id);var b=this;$.get(a,function(c){b.parent.utils.update_status("completed");if(c.result=="success"){full_url=window.location.origin+c.url;$("#mlab_download_qr2").empty().qrcode({text:full_url,render:"table"}).show().append("<br>").append("<a href='"+full_url+"'>"+_tr["mlab.dt.management.js.app_download_process.1"]+": "+full_url+"</a>").append("<br>").append("<a href='mailto:"+b.parent.user_email+"?subject=Link&body="+_tr["mlab.dt.management.js.app_download_process.2"]+": "+encodeURI(full_url)+"'>"+_tr["mlab.dt.management.js.app_download_process.3"]+"</a>")}else{$("#mlab_download_qr2").empty().append("<p>"+_tr["mlab.dt.management.js.app_download_process.4"]+": "+c.msg+"</p>").show()}});b.parent.utils.timer_start()},app_submit_to_market:function(){alert(_tr["mlab.dt.management.js.app_submit_to_market"])},app_remove_locks:function(){this.parent.utils.update_status("temporary",_tr["mlab.dt.management.js.update_status.unlocking.pages"],true);$.get(this.parent.urls.app_unlock);$("#"+this.parent.config.app["content_id"]).fadeTo("slow",1);$("#mlab_editor_disabled").remove();this.parent.app.locked=false},app_update_gui_metadata:function(){var c=$("<ol></ol>");var a=this.parent.app.curr_page_num;var b="";if(a=="index"){a=0}for(i in this.parent.app.page_names){if(i>0){b="<span class='mlab_copy_file' title='"+_tr["mlab.dt.management.js.app_update_gui_metadata.copy.pages"]+" "+i+"' onclick='mlab.dt.management.page_copy(\""+i+"\");' >&nbsp;</span>"}if(i==0){b="<span class='mlab_not_copy_file'>&nbsp;</span>"}if(i==a){c.append("<li data-mlab-page-open='"+i+"'>"+b+this.parent.app.page_names[i]+"</li>")}else{c.append("<li>"+b+"<a data-mlab-page-open='"+i+"' href='javascript:mlab.dt.management.page_open("+this.parent.app.id+', "'+i+"\");'>"+this.parent.app.page_names[i]+"</a></li>")}}$("#mlab_existing_pages").html(c);$("#mlab_edit_app_title").text(this.parent.app.name);$("#mlab_edit_app_description").text(this.parent.app.description);$("#mlab_edit_app_keywords").text(this.parent.app.keywords);$("#mlab_edit_app_category1").text(this.parent.app.categoryOne);$("#mlab_edit_app_category2").text(this.parent.app.categoryTwo);$("#mlab_edit_app_category3").text(this.parent.app.categoryThree)},index_page_process:function(j,a,e){var q,m,r;var c="";var b=this.parent.config.urls.app+this.parent.app.path+"/"+this.parent.app.active_version+"/";var o=(new DOMParser()).parseFromString(j,"text/html");if(o.getElementById(this.parent.config.app["content_id"])==null){alert(_tr["mlab.dt.management.js.index_page_process.alert.1"]+" "+this.parent.config.app["content_id"]+", "+_tr["mlab.dt.management.js.index_page_process.alert.2"]);return}document.getElementsByTagName("base")[0].href=b;$("#mlab_editor_chrome").empty();$("link[rel=stylesheet][href^='css']").remove();var n=o.getElementsByTagName("head")[0];var l=o.getElementById(this.parent.config.app["content_id"]).cloneNode(true).childNodes;var h=o.getElementById(this.parent.config.app["content_id"]);while(h.firstChild){h.removeChild(h.firstChild)}var g=o.getElementsByTagName("body")[0].cloneNode(true);var p=n.getElementsByTagName("link");for(var f=0;f<p.length;f++){r=p[f].getAttribute("href");if(r.indexOf("style_rt.css")<0){c=c+"<link rel='stylesheet' href='"+r+"' type='text/css'>\n"}}$("head link[rel='stylesheet']").last().after(c);$("#mlab_editor_chrome").append(g.innerHTML);if(e){$("#"+this.parent.config.app["content_id"]).html(l);this.parent.api.getAllLibraries();this.parent.design.prepare_editable_area()}this.parent.app.curr_indexpage_html=o;this.parent.app.curr_pagetitle=n.getElementsByTagName("title")[0].innerText;this.parent.app.curr_page_num=a;$("#mlab_page_control_title").text(this.parent.app.curr_pagetitle);this.app_update_gui_metadata();try{$.mobile.initializePage()}catch(d){console.log(d.message)}mlab.dt.api.display.updateDisplay();var k=(parseInt($("#mlab_editor_chrome").css("margin-bottom"))*2)+parseInt($("#mlab_editor_chrome").css("border-bottom-width"));$("[data-role=header]").css({position:"absolute","z-index":0});$("[data-role=footer]").css({position:"absolute",bottom:($("[data-role=footer]").height()+k)+"px"});$("[data-role=page]").css({width:"100%",height:"100%","min-height":"",position:"absolute",margin:"0",padding:"0","padding-top":$("[data-role=header]").height()+"px","padding-bottom":$("[data-role=footer]").height()+"px"});$("#panel_left").css("background-image",$("#panel_left").css("background-image"));$("#panel_right").css("background-image",$("#panel_right").css("background-image"))},regular_page_process:function(e,a){var j,f,k;var b=this.parent.config.urls.app+this.parent.app.path+"/"+this.parent.app.active_version+"/";$("#"+this.parent.config.app["content_id"]).html("");if(e==""){e=this.parent.config.app["html_header"].replace("%TITLE%","Title")+this.parent.config.app["html_footer"];e=e.replace(/\\n/g,"\n")}var h=(new DOMParser()).parseFromString(e,"text/html");var g=h.getElementsByTagName("head")[0];var d=h.getElementsByClassName("mlab_main_body_content")[0].cloneNode(true);this.parent.app.curr_pagetitle=g.getElementsByTagName("title")[0].innerText;this.parent.app.curr_page_num=a;$("#mlab_page_control_title").text(this.parent.app.curr_pagetitle);this.app_update_gui_metadata();$("#"+this.parent.config.app["content_id"]).html(d.innerHTML);this.parent.api.getAllLibraries();this.parent.design.prepare_editable_area();try{$.mobile.initializePage()}catch(c){console.log(c.message)}mlab.dt.api.display.updateDisplay()},page_move_to:function(b){var a=0;(this.parent.app.curr_page_num=="index")?a=0:a=parseInt(this.parent.app.curr_page_num);if(b<0&&a>0){a--}else{if(b>0){a++}else{return}}this.page_open(this.parent.app.id,a)},page_open:function(a,b){that=this;this.page_save(function(){that.page_open_process(a,b)})},page_open_process:function(b,c){this.parent.utils.update_status("callback",_tr["mlab.dt.management.js.update_status.opening.page"],true);var a=this.parent.urls.page_get.replace("_ID_",b);a=a.replace("_PAGE_NUM_",c);a=a.replace("_UID_",this.parent.uid);if(typeof this.parent.qtip_tools!="undefined"){$(this.parent.qtip_tools).qtip("hide");this.parent.qtip_tools=undefined;if(typeof this.parent.api.properties_tooltip!="undefined"){$(this.parent.api.properties_tooltip).qtip("hide");this.parent.api.properties_tooltip=undefined}}var d=this;$.get(a,function(e){if(e.result=="success"){d.parent.utils.update_status("completed");d.parent.utils.update_status("permanent",d.parent.app.name);$("#mlab_page_control_title").text(d.parent.app.curr_pagetitle);if(e.page_num_sent==0||e.page_num_sent=="index"){d.index_page_process(e.html,"index",true);$(".mlab_current_component").find("a[href=MLAB_DT_LINK_TEMP]").click(function(g){g.preventDefault()})}else{if(e.page_num_sent=="last"&&e.page_num_real==0){d.parent.utils.timer_start();if($("#mlab_overlay").is(":visible")){$("#mlab_overlay").slideUp()}return}else{d.regular_page_process(e.html,e.page_num_real);var f=window.location.pathname.split("/");f[f.length-3]=e.app_id;f[f.length-2]=e.page_num_real;history.pushState({id:e.app_id,page:e.page_num_real},d.parent.app.curr_pagetitle,f.join("/"))}}if(e.lock_status=="locked"){d.parent.app.locked=true;$("#"+d.parent.config.app["content_id"]).fadeTo("slow",0.6);$("div.container").append('<div id="mlab_editor_disabled" style="background-color: gray; position: absolute;top:110px;left:0;width: 100%;height:100%;z-index:2;opacity:0.4;filter: alpha(opacity = 50); background-image: url(/img/page_locked.png); background-repeat: no-repeat; background-position: 95% 2%;"></div>')}else{d.parent.app.locked=false;$("#mlab_editor_disabled").remove();$("#"+d.parent.config.app["content_id"]).fadeTo("slow",1)}if($("#mlab_overlay").is(":visible")){$("#mlab_overlay").slideUp()}$("#mlab_editable_area").find("a").click(function(g){g.preventDefault()});d.parent.utils.timer_start()}else{d.parent.utils.update_status("temporary",e.msg,false)}})},page_update_title:function(){if(this.parent.app.locked){alert(_tr["mlab.dt.management.js.page_update_title.alert.page.locked"]);return}if(this.parent.app.curr_page_num=="index"){var a=0}else{var a=this.parent.app.curr_page_num}this.parent.flag_dirty=true;this.parent.app.curr_pagetitle=$("#mlab_page_control_title").text();this.parent.app.page_names[this.parent.app.curr_page_num]=this.parent.app.curr_pagetitle;$("#mlab_page_control_title").text(this.parent.app.curr_pagetitle);$("#mlab_existing_pages [data-mlab-page-open='"+a+"']").html("<span class='mlab_copy_file' onclick='this.page_copy(\""+a+"\");' >&nbsp;</span>"+this.parent.app.curr_pagetitle)},page_save:function(j,c){this.parent.utils.timer_stop();var o=true;var m=false;this.parent.counter_saving_page++;if($("#mlab_editor_disabled").length>0){console.log("Page locked, did not save");o=false}if(typeof this.parent.app.curr_page_num=="undefined"||typeof this.parent.app.id=="undefined"){o=false}if(!this.parent.flag_dirty&&typeof c=="undefined"){o=false}if((!o)&&(typeof j!="undefined")){return j()}else{if(!o){this.parent.utils.timer_start();return false}}this.parent.utils.update_status("callback",_tr["mlab.dt.management.js.update_status.storing.page"],true);var n=$("#"+this.parent.config.app["content_id"]+" .mlab_current_component");n.removeClass("mlab_current_component");var k=this.parent.app.id;var a=this.parent.app.curr_page_num;var d="";var f=new Object();var l=new Array();var b=this.parent.urls.page_save.replace("_ID_",k);b=b.replace("_PAGE_NUM_",a);b=b.replace("_CHECKSUM_",this.parent.app.app_checksum);var h=this;$("#"+h.parent.config.app["content_id"]).children("div").each(function(){var p=$(this).data("mlab-type");if(typeof h.parent.components[p].code!=="undefined"&&typeof h.parent.components[p].code.onSave!=="undefined"){d=d+h.parent.components[p].code.onSave(this)}else{d=d+$(this)[0].outerHTML+"\n"}h.parent.bestpractice.component_check_content(this,p,f,l)});this.parent.bestpractice.page_check_content(f,l);if(a==0||a=="index"){var e=this.parent.app.curr_indexpage_html;e.getElementById(this.parent.config.app["content_id"]).innerHTML=d;e.title=this.parent.app.curr_pagetitle;var g=(new XMLSerializer()).serializeToString(e)}else{var g=d}n.addClass("mlab_current_component");var h=this;$.post(b,{title:this.parent.app.curr_pagetitle,html:g},function(p){h.parent.counter_saving_page--;if(p.result=="success"){h.parent.utils.update_status("temporary",_tr["mlab.dt.management.js.update_status.saved.page"],false);h.parent.flag_dirty=false;if(typeof j!="undefined"){m=j()}if(typeof p.app_info!="undefined"){if(p.app_info.result==="file_changes"){console.log("App files were changed");h.parent.app.app_checksum=p.app_info.mlab_app_checksum;h.parent.app.page_names=p.app_info.mlab_app.page_names}else{if(p.app_info.result==="no_file_changes"){console.log("No changes to app files")}else{if(h.parent.counter_saving_page==0&&(typeof j=="undefined")){h.parent.utils.timer_start()}return}}h.parent.app.name=p.app_info.mlab_app.name;h.parent.app.description=p.app_info.mlab_app.description;h.parent.app.keywords=p.app_info.mlab_app.keywords;h.parent.app.categoryOne=p.app_info.mlab_app.categoryOne;h.parent.app.categoryTwo=p.app_info.mlab_app.categoryTwo;h.parent.app.categoryThree=p.app_info.mlab_app.categoryThree;h.app_update_gui_metadata()}}else{h.parent.utils.update_status("temporary",_tr["mlab.dt.management.js.update_status.unable.save.page"]+": "+p.msg,false);if(typeof j!="undefined"){$("#mlab_dialog_confirm").dialog({resizable:false,height:140,modal:true,buttons:{Retry:function(){$(this).dialog("close");h.page_save(j);return},Continue:function(){$(this).dialog("close");m=j()},Cancel:function(){$(this).dialog("close")}}});return m}}if(h.parent.counter_saving_page==0&&(typeof j=="undefined")){h.parent.utils.timer_start()}});if(l.length>0){$("#mlab_statusbar_permanent").qtip({content:{text:"<ul><li>"+l.join("</li><li>")+"</li></ul>"},position:{my:"topMiddle",at:"bottomMiddle"},show:{ready:true},hide:{event:"unfocus"},style:{"background-color":"white",color:"blue",classes:"mlab_qtip_info"}});window.setTimeout(function(){$(".mlab_qtip_info").remove()},5000)}else{$(".mlab_qtip_info").remove()}return m},page_new:function(){var a=prompt(_tr["mlab.dt.management.js.page_new.prompt.title.new.page"]);if(a!=null){that=this;this.page_save(function(){that.page_new_process(a)})}},page_new_process:function(c){$("body").css("cursor","wait");this.parent.utils.update_status("callback",_tr["mlab.dt.management.js.update_status.storing.page"],true);var a=this.parent.urls.page_new.replace("_ID_",this.parent.app.id);a=a.replace("_UID_",this.parent.uid);if(typeof this.parent.qtip_tools!="undefined"){$(this.parent.qtip_tools).qtip("hide");this.parent.qtip_tools=undefined;if(typeof this.parent.api.properties_tooltip!="undefined"){$(this.parent.api.properties_tooltip).qtip("hide");this.parent.api.properties_tooltip=undefined}}var b=this;$.post(a,{},function(d){if(d.result=="success"){b.parent.utils.update_status("completed");$("#"+b.parent.config.app["content_id"]).empty();b.parent.app.curr_pagetitle=c;b.parent.app.curr_page_num=d.page_num_real;$("#mlab_page_control_title").text(b.parent.app.curr_pagetitle);b.parent.app.page_names[b.parent.app.curr_page_num]=c;b.app_update_gui_metadata();b.parent.flag_dirty=true;$("body").css("cursor","default")}else{b.parent.utils.update_status("temporary",d.msg,false);$("body").css("cursor","default")}b.parent.utils.timer_start()})},page_copy:function(a){if(a=="0"||a=="index"){alert(_tr["mlab.dt.management.js.page_copy.alert.not.copy.index.page"]);return}that=this;this.page_save(function(){that.page_copy_process(a)})},page_copy_process:function(b){var a=this.parent.urls.page_copy.replace("_ID_",this.parent.app.id);a=a.replace("_PAGE_NUM_",b);a=a.replace("_UID_",this.parent.uid);this.parent.utils.update_status("callback",_tr["mlab.dt.management.js.update_status.copying.page"],true);var c=this;$.get(a,function(d){c.parent.utils.update_status("completed");if(d.result=="success"){c.parent.app.curr_pagetitle=d.page_title;$("#mlab_page_control_title").text(d.page_title);c.parent.app.page_names[d.page_num_real]=d.page_title;c.regular_page_process(d.html,d.page_num_real)}else{alert(d.msg)}c.parent.utils.timer_start()})},page_delete:function(){if(this.parent.app.curr_page_num=="0"||this.parent.app.curr_page_num=="index"){alert(_tr["mlab.dt.management.js.page_copy.alert.not.delete.index.page"]);return}if(!confirm(_tr["mlab.dt.management.js.page_copy.alert.sure.delete"])){return}this.parent.utils.timer_stop();this.parent.utils.update_status("callback",_tr["mlab.dt.management.js.update_status.deleting.page"],true);var a=this.parent.urls.page_delete.replace("_ID_",this.parent.app.id);a=a.replace("_PAGE_NUM_",this.parent.app.curr_page_num);a=a.replace("_UID_",this.parent.uid);var b=this;$.get(a,function(c){b.parent.utils.update_status("completed");if(c.result=="success"){$("#mlab_existing_pages [data-mlab-page-open='"+b.parent.app.curr_page_num+"']").remove();b.parent.app.page_names.splice(b.parent.app.curr_page_num,1);b.regular_page_process(c.html,c.page_num_real);if(b.parent.app.curr_page_num=="index"){$("#mlab_existing_pages [data-mlab-page-open='"+b.parent.app.curr_page_num+"']").html(b.parent.app.curr_pagetitle)}else{$("#mlab_existing_pages [data-mlab-page-open='"+b.parent.app.curr_page_num+"']").html("<span class='mlab_copy_file' onclick='mlab.dt.management.page_copy(\""+b.parent.app.curr_page_num+"\");' >&nbsp;</span>"+b.parent.app.curr_pagetitle)}}else{b.parent.utils.update_status("temporary",c.msg,false)}b.parent.utils.timer_start()})},page_preview:function(){that=this;this.page_save(function(){that.page_preview_process()})},page_preview_process:function(){var b=this.parent.urls.app_preview.replace("_APPID_",this.parent.app.id);var a=$(window).width()*0.25;var d=$(window).height()*0.75;var c=window.open(b,"targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width="+a+",height="+d+",left="+a);if(c==undefined){alert(_tr["mlab.dt.management.js.page_preview_process.alert.cannot.open.new.window"])}},market:{login:function(){},submit_app_details:function(){},upload_app_file:function(){},publish_app:function(){},unpublish_app:function(){}},compiler:{get_app_status:function(){var b=mlab.dt.urls.cmp_get_app_status.replace("_WINDOW_UID_",mlab.dt.uid);var c=prompt(_tr["mlab.dt.management.js.compiler.get_app_status.prompt.db.id"]);b=b.replace("/_ID_",((c!=null&&c!="")?"/"+c:""));var a=prompt(_tr["mlab.dt.management.js.compiler.get_app_status.prompt.version"]);b=b.replace("/_VERSION_",((a!=null&&a!="")?"/"+a:""));var d=prompt(_tr["mlab.dt.management.js.compiler.get_app_status.prompt.platform"]);b=b.replace("/_PLATFORM_",((d!=null&&d!="")?"/"+d:""));$.getJSON(b,function(e){if(e.result=="success"){console.log("Status returned: ");console.log(e.app_status)}else{alert(_tr["mlab.dt.management.js.compiler.get_app_status.alert.unable.get.app.status"])}})},get_app:function(a){var c=mlab.dt.urls.cmp_get_app_process.replace("_WINDOW_UID_",mlab.dt.uid);c=c.replace("_ID_",mlab.dt.app.id);c=c.replace("_VERSION_",mlab.dt.app.active_version);c=c.replace("_PLATFORM_",a);var b=_tr["mlab.dt.management.js.compiler.get_app.status.creating.app"];$("#mlab_statusbar_compiler").text(b);$("#mlab_download_"+a+"_icon").find("img").show();$("#mlab_download_"+a+"_icon").addClass("mlab_download_"+a+"_icon_grey");$("#mlab_progressbar").show();$("#mlab_progressbar").val(2);$.getJSON(c,function(d){if(d.result!="success"){$("#mlab_statusbar_compiler").text("");$("#mlab_progressbar").hide();mlab.dt.utils.update_status("temporary",_tr["mlab.dt.management.js.update_status.unable.contact.server"],false);$("#mlab_download_"+a+"_icon").find("img").hide();$("#mlab_download_"+a+"_icon").removeClass("mlab_download_"+a+"_icon_grey")}})}}};